# üìö DOCUMENTACI√ìN EXHAUSTIVA - SISTEMA CLINICACLICK

## üéØ INFORMACI√ìN GENERAL

**Proyecto**: ClinicaClick - Sistema de gesti√≥n de cl√≠nicas con roles avanzados  
**Arquitectura**: Frontend Angular 19 + Backend Node.js/Express + Base de datos MySQL  
**Framework Frontend**: Fuse Angular (Material Design)  
**Estado Actual**: Fase 3 completada - Sistema de roles, OAuth Meta, mapeo de activos  

---

## üèóÔ∏è ARQUITECTURA DEL SISTEMA

### **REPOSITORIOS**
- **Frontend**: https://github.com/Chervas/cc-front
- **Backend**: https://github.com/Chervas/cc-back
- **Demo**: https://github.com/Chervas/cc-demo

## Main Navigation

The application provides several main routes that can be accessed from the side menu:

- **Usuarios** ‚Äì `/apps/contacts`
- **Cl√≠nicas** ‚Äì `/apps/clinicas`
- **Pacientes** ‚Äì `/pacientes`
- **Contabilidad** ‚Äì `/apps/ventas/*` (services, invoices, etc.)
- **Marketing** ‚Äì `/marketing`

These entries are configured in `src/app/mock-api/common/navigation/data.ts` and dynamically loaded by the `RoleInterceptor`.

### **TECNOLOG√çAS PRINCIPALES**
- **Frontend**: Angular 19, Fuse UI, TypeScript, RxJS, Transloco
- **Backend**: Node.js, Express, Sequelize ORM
- **Base de Datos**: MySQL
- **Autenticaci√≥n**: JWT + OAuth Meta (Facebook)
- **Estilos**: Fuse Material Design (NO SCSS custom)

### **ARQUITECTURA DUAL DE USUARIOS**

El sistema implementa una arquitectura dual que separa claramente las responsabilidades entre la interfaz de usuario y la l√≥gica de negocio. Esta separaci√≥n permite mantener la compatibilidad con el framework FUSE mientras se implementa la l√≥gica espec√≠fica del dominio m√©dico.

#### **Usuario FUSE (Interfaz)**
El usuario FUSE se utiliza exclusivamente para elementos visuales y de interfaz de usuario. Este modelo se encuentra implementado en `src/app/layout/common/user/user.component.ts` y maneja √∫nicamente informaci√≥n superficial como el nombre mostrado, avatar, y estados de conexi√≥n (Online, Away, Busy, Invisible).

**Caracter√≠sticas del Usuario FUSE:**
- **ID:** String alfanum√©rico utilizado solo para identificaci√≥n visual
- **Prop√≥sito:** Elementos de UI/UX del template FUSE
- **Campos principales:** `user.id`, `user.email`, `user.name`, `user.avatar`, `user.status`
- **Limitaciones:** No debe utilizarse para l√≥gica de negocio o autenticaci√≥n

#### **Usuario de Negocio (L√≥gica de Aplicaci√≥n)**
El usuario de negocio contiene toda la informaci√≥n cr√≠tica para el funcionamiento de la aplicaci√≥n m√©dica. Este modelo se gestiona a trav√©s de `src/app/core/auth/auth.service.ts` y se conecta directamente con la base de datos a trav√©s del modelo `models/usuario.js` en el backend.

**Caracter√≠sticas del Usuario de Negocio:**
- **ID:** N√∫mero entero (`id_usuario`) que corresponde a la clave primaria en base de datos
- **Prop√≥sito:** Autenticaci√≥n, autorizaci√≥n, gesti√≥n de cl√≠nicas, OAuth2
- **Campos principales:** `user.id_usuario`, `user.email_usuario`, `user.nombre`, `user.apellidos`
- **Funcionalidades:** Login, permisos, relaciones con cl√≠nicas, roles espec√≠ficos

#### **‚ö†Ô∏è IMPORTANTE: Separaci√≥n de Responsabilidades**
```typescript
// ‚ùå INCORRECTO - Mezclar usuarios FUSE con l√≥gica de negocio
if (fuseUser.id === 'admin') { /* l√≥gica de permisos */ }

// ‚úÖ CORRECTO - Usar usuario de negocio para l√≥gica
if (businessUser.id_usuario === 1 && this.roleService.isAdmin()) { /* l√≥gica de permisos */ }

// ‚úÖ CORRECTO - Usar usuario FUSE solo para UI
<div>Bienvenido, {{fuseUser.name}}</div>
<img [src]="fuseUser.avatar" alt="Avatar">
```

---

## üóÑÔ∏è ESTRUCTURA DE BASE DE DATOS

### **TABLAS PRINCIPALES**
```sql
-- Tablas identificadas en la BD:
AdCaches, Campanas, ClinicMetaAssets, ClinicaServicio, Clinicas, 
Facturas, GruposClinicas, HistorialDeServicios, Leads, 
MetaConnections, Pacientes, SequelizeMeta, Servicios, 
UsuarioClinica, Usuarios
```

### **MODELO USUARIO** (`models/usuario.js`)
```javascript
// Campos principales:
- id_usuario (INTEGER, primaryKey, autoIncrement)
- nombre (STRING)
- apellidos (STRING) 
- email_usuario (STRING)
- email_factura (STRING)
- email_notificacion (STRING)
- password_usuario (STRING)
- fecha_creacion (DATE, defaultValue: NOW)
- id_gestor (INTEGER)
- notas_usuario (STRING)
- telefono (STRING)
- cargo_usuario (STRING)
- cumpleanos (DATE)
- isProfesional (BOOLEAN, allowNull: false, defaultValue: false)

// Configuraci√≥n:
- modelName: 'Usuario'
- tableName: 'Usuarios'
- timestamps: true
```

### **MODELO USUARIOCLINICA** (`models/usuarioclinica.js`)
```javascript
// Campos principales:
- id_usuario (INTEGER, primaryKey)
- id_clinica (INTEGER, primaryKey)
- rol_clinica (ENUM: 'paciente', 'personaldeclinica', 'propietario', defaultValue: 'paciente')
- subrol_clinica (ENUM: 'Auxiliares y enfermeros', 'Doctores', 'Administrativos', allowNull: true, defaultValue: null)
- datos_fiscales_clinica (JSON, allowNull: true)

// Configuraci√≥n:
- modelName: 'UsuarioClinica'
- tableName: 'UsuarioClinica'
- timestamps: true
```

### **RELACIONES**
```javascript
// Usuario -> UsuarioClinica -> Clinica (Many-to-Many)
Usuario.belongsToMany(models.Clinica, {
    through: models.UsuarioClinica,
    foreignKey: 'id_usuario',
    otherKey: 'id_clinica',
    as: 'Clinicas'
});
```

---

## üé≠ SISTEMA DE ROLES

### **MAPEO BACKEND ‚Üî FRONTEND**

**Backend (Base de Datos)**:
```javascript
rol_clinica: ENUM('paciente', 'personaldeclinica', 'propietario')
subrol_clinica: ENUM('Auxiliares y enfermeros', 'Doctores', 'Administrativos')
```

**Frontend (TypeScript)**:
```typescript
enum UserRole {
    ADMIN = 'ADMIN',
    PROPIETARIO = 'PROPIETARIO', 
    DOCTOR = 'DOCTOR',
    PERSONAL_CLINICA = 'PERSONAL_CLINICA',
    PACIENTE = 'PACIENTE'
}
```

### **CONFIGURACI√ìN DE ROLES** (`src/app/core/constants/role.constants.ts`)

```typescript
export const ROLE_CONFIG = {
    // üëë ADMINISTRADORES (centralizado y seguro)
    ADMIN_USER_IDS: [1],
    
    // üé® ETIQUETAS VISUALES
    ROLE_LABELS: {
        [UserRole.ADMIN]: 'Administrador',
        [UserRole.PROPIETARIO]: 'Propietario',
        [UserRole.DOCTOR]: 'Doctor',
        [UserRole.PERSONAL_CLINICA]: 'Personal de Cl√≠nica',
        [UserRole.PACIENTE]: 'Paciente'
    },
    
    // üîê PERMISOS POR ROL (granulares y seguros)
    ROLE_PERMISSIONS: {
        [UserRole.ADMIN]: ['*', 'system.manage', 'users.manage', 'clinics.manage'],
        [UserRole.PROPIETARIO]: ['clinic.manage', 'clinic.view_patients', 'assets.map'],
        [UserRole.DOCTOR]: ['clinic.view_patients', 'clinic.manage_appointments'],
        [UserRole.PERSONAL_CLINICA]: ['clinic.view_patients', 'appointments.view'],
        [UserRole.PACIENTE]: ['profile.view_own', 'appointments.view_own']
    },

    // üîê ACCIONES SENSIBLES
    SENSITIVE_ACTIONS: {
        'assets.map': [UserRole.ADMIN, UserRole.PROPIETARIO],
        'clinic.manage_settings': [UserRole.ADMIN, UserRole.PROPIETARIO],
        'users.manage': [UserRole.ADMIN]
    }
};
```

### **JERARQU√çA DE ROLES**
```typescript
export const ROLE_HIERARCHY = {
    [UserRole.ADMIN]: 5,
    [UserRole.PROPIETARIO]: 4,
    [UserRole.DOCTOR]: 3,
    [UserRole.PERSONAL_CLINICA]: 2,
    [UserRole.PACIENTE]: 1
};
```

---

## üîß SERVICIOS PRINCIPALES

### **ROLE SERVICE** (`src/app/core/services/role.service.ts`)

**M√©todos P√∫blicos Disponibles**:
```typescript
// Observables principales
currentUser$: Observable<UsuarioConRoles>
selectedRole$: Observable<UserRole>
availableRoles$: Observable<UserRole[]>

// M√©todos de verificaci√≥n
hasRole(role: UserRole): boolean
isAdmin(): boolean
hasPermission(permission: string): Observable<boolean>
hasAnyPermission(permissions: string[]): Observable<boolean>

// M√©todos de gesti√≥n
loadUserRolesFromBackend(): Observable<any>
getClinicasByCurrentRole(): ClinicaConRol[]
getCurrentPermissions(): string[]
```

### **PERMISSION SERVICE** (`src/app/core/services/permission.service.ts`)

**M√©todos Disponibles**:
```typescript
// M√©todos de verificaci√≥n de permisos
hasPermission(permission: string): Observable<boolean>
hasAnyPermission(permissions: string[]): Observable<boolean>
reloadPermissions(): void
```

---

## üõ°Ô∏è SISTEMA DE SEGURIDAD

### **GUARDS** (`src/app/core/auth/guards/`)
- **role.guard.ts**: Protege rutas basado en roles
- **auth.guard.ts**: Verifica autenticaci√≥n
- **noAuth.guard.ts**: Redirige usuarios autenticados

### **INTERCEPTORS** (`src/app/core/auth/interceptors/`)
- **role.interceptor.ts**: Agrega headers de rol autom√°ticamente
- **auth.interceptor.ts**: Maneja tokens JWT

### **DIRECTIVAS** (`src/app/modules/admin/apps/roles/shared/`)
- **has-role.directive.ts**: `*hasRole="'ADMIN'"` - Muestra/oculta por rol
- **has-permission.directive.ts**: `*hasPermission="'clinic.manage'"` - Muestra/oculta por permiso

---

## üé® ESTRUCTURA FRONTEND

### **RUTAS PRINCIPALES** (`src/app/app.routes.ts`)
```typescript
// Rutas principales identificadas:
/dashboard - Panel principal
/roles-test - Componente de testing de roles
/oauth - Configuraci√≥n OAuth Meta
/assets - Mapeo de activos
```

### **COMPONENTES CLAVE**

**1. Role Test Component** (`src/app/modules/admin/apps/roles/components/`)
- **role-test-component.ts**: L√≥gica del componente
- **role-test-component.html**: Template con directivas *hasRole y *hasPermission
- **Prop√≥sito**: Testing y debugging del sistema de roles

**2. Clinic Selector** (`src/app/layout/`)
- **Prop√≥sito**: Selector de cl√≠nicas en el men√∫ lateral
- **Estado**: Corregido seg√∫n commits

### **CONFIGURACI√ìN PRINCIPAL** (`src/app/app.config.ts`)

**Providers Configurados**:
```typescript
// Transloco (Internacionalizaci√≥n)
provideTransloco({
    config: {
        availableLangs: [
            { id: 'en', label: 'English' },
            { id: 'tr', label: 'Turkish' }
        ],
        defaultLang: 'en',
        fallbackLang: 'en',
        reRenderOnLangChange: true,
        prodMode: true
    },
    loader: TranslocoHttpLoader
})

// HTTP Interceptors
provideHttpClient(
    withInterceptors([
        authInterceptor,
        roleInterceptor  // ‚ö†Ô∏è DEBE estar incluido
    ])
)

// Sistema de Roles
RoleService,
PermissionService,
RoleGuard
```

---

## üîó INTEGRACI√ìN OAUTH META

### **CONFIGURACI√ìN**
- **Prop√≥sito**: Autenticaci√≥n con Facebook para cl√≠nicas
- **Estado**: Implementado pero puede interferir con interceptor de roles
- **Archivos**: `ClinicMetaAsset.js`, `MetaConecction.js`

### **CONSIDERACI√ìN IMPORTANTE**
```typescript
// El roleInterceptor debe excluir dominios externos:
function shouldInterceptRequest(url: string): boolean {
    const excludedDomains = [
        'graph.facebook.com',
        'connect.facebook.net'
    ];
    return !excludedDomains.some(domain => url.includes(domain));
}
```

---

## üéØ MAPEO DE ACTIVOS

### **FUNCIONALIDAD**
- **Prop√≥sito**: Mapear activos de cl√≠nicas con Meta (Facebook)
- **Permisos**: Solo ADMIN y PROPIETARIO
- **Estado**: Implementado en Fase 3

---

## üêõ PROBLEMAS CONOCIDOS Y SOLUCIONES

### **1. ERROR toUpperCase()**
**Causa**: Configuraci√≥n incorrecta de Transloco  
**Soluci√≥n**: Usar `prodMode: true` y `TranslocoHttpLoader`

### **2. Directivas No Funcionan**
**Causa**: Directivas no importadas en componentes standalone  
**Soluci√≥n**: 
```typescript
import { HasRoleDirective } from '../shared/has-role.directive';
import { HasPermissionDirective } from '../shared/has-permission.directive';

@Component({
    imports: [HasRoleDirective, HasPermissionDirective]
})
```

### **3. Usuario Sin Roles**
**Causa**: Tabla UsuarioClinica vac√≠a para el usuario  
**Soluci√≥n**: Insertar roles en BD:
```sql
INSERT INTO UsuarioClinica (id_usuario, id_clinica, rol_clinica, subrol_clinica) 
VALUES 
(1, 1, 'propietario', NULL),
(1, 2, 'personaldeclinica', 'Doctores');
```

### **4. Interceptor No Incluido**
**Causa**: `roleInterceptor` no est√° en `app.config.ts`  
**Soluci√≥n**: Agregarlo a `withInterceptors([roleInterceptor])`

---

## üìã ESTADO ACTUAL DEL PROYECTO

### **‚úÖ COMPLETADO**
- ‚úÖ Sistema de roles completo (Fase 3)
- ‚úÖ OAuth Meta integrado
- ‚úÖ Mapeo de activos
- ‚úÖ Directivas *hasRole y *hasPermission
- ‚úÖ Guards y interceptors
- ‚úÖ Selector de cl√≠nicas
- ‚úÖ Configuraci√≥n Transloco

### **‚ö†Ô∏è PROBLEMAS IDENTIFICADOS**
- ‚ùå Directivas no importadas en componentes
- ‚ùå Usuario de prueba sin roles en BD
- ‚ùå Interceptor no incluido en configuraci√≥n
- ‚ùå Posible interferencia OAuth con interceptor

### **üîß TAREAS PENDIENTES**
1. **Restaurar directivas** en role-test-component
2. **Incluir roleInterceptor** en app.config.ts
3. **Asignar roles** al usuario de prueba en BD
4. **Configurar exclusiones** en interceptor para OAuth
5. **Testing completo** del sistema de roles

---

## üöÄ GU√çA DE IMPLEMENTACI√ìN R√ÅPIDA

### **PASO 1: Corregir Componente Role-Test**
```bash
# Archivo: src/app/modules/admin/apps/roles/components/role-test-component.ts
# Agregar imports:
import { HasRoleDirective } from '../shared/has-role.directive';
import { HasPermissionDirective } from '../shared/has-permission.directive';

# En @Component decorator:
imports: [HasRoleDirective, HasPermissionDirective]
```

### **PASO 2: Incluir Interceptor**
```bash
# Archivo: src/app/app.config.ts
# Agregar import:
import { roleInterceptor } from './core/auth/interceptors/role.interceptor';

# En providers:
withInterceptors([authInterceptor, roleInterceptor])
```

### **PASO 3: Asignar Roles en BD**
```sql
-- Conectar a MySQL
mysql -u root -p clinicaclick

-- Insertar roles de prueba
INSERT INTO UsuarioClinica (id_usuario, id_clinica, rol_clinica, subrol_clinica) 
VALUES 
(1, 1, 'propietario', NULL),
(1, 2, 'personaldeclinica', 'Doctores'),
(1, 3, 'paciente', NULL);
```

### **PASO 4: Verificar Funcionamiento**
```bash
# Compilar
npm run build -- --configuration=production

# Ejecutar
npm start

# Navegar a /roles-test
# Verificar logs en consola del navegador
```

---

## üìÅ ESTRUCTURA DE ARCHIVOS CLAVE

```
cc-front/
‚îú‚îÄ‚îÄ src/app/
‚îÇ   ‚îú‚îÄ‚îÄ app.config.ts                    # Configuraci√≥n principal
‚îÇ   ‚îú‚îÄ‚îÄ app.routes.ts                    # Rutas de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ role.constants.ts        # Constantes de roles
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ role.service.ts          # Servicio principal de roles
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permission.service.ts    # Servicio de permisos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ role.guard.ts        # Guard de roles
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ interceptors/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ role.interceptor.ts  # Interceptor de roles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transloco/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ transloco.http-loader.ts # Loader de traducciones
‚îÇ   ‚îî‚îÄ‚îÄ modules/admin/apps/roles/
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ role-test-component.ts   # Componente de testing
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ role-test-component.html # Template con directivas
‚îÇ       ‚îî‚îÄ‚îÄ shared/
‚îÇ           ‚îú‚îÄ‚îÄ has-role.directive.ts    # Directiva *hasRole
‚îÇ           ‚îî‚îÄ‚îÄ has-permission.directive.ts # Directiva *hasPermission

cc-back/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ usuario.js                       # Modelo Usuario
‚îÇ   ‚îú‚îÄ‚îÄ usuarioclinica.js               # Modelo UsuarioClinica
‚îÇ   ‚îî‚îÄ‚îÄ clinica.js                      # Modelo Clinica
‚îî‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ routes/                         # Rutas API
```

---

## üîç DEBUGGING Y LOGS

### **LOGS IMPORTANTES**
```javascript
// En RoleService:
console.log('[RoleService] Usuario cargado:', user);
console.log('[RoleService] Roles disponibles:', roles);

// En PermissionService:
console.log('[PermissionService] Permisos cargados:', permissions);

// En Directivas:
console.log('[HasRoleDirective] Evaluando rol:', role);
console.log('[HasPermissionDirective] Evaluando permiso:', permission);
```

### **VERIFICACIONES R√ÅPIDAS**
```bash
# 1. Verificar roles en BD
SELECT u.email_usuario, uc.rol_clinica, uc.subrol_clinica 
FROM Usuarios u 
JOIN UsuarioClinica uc ON u.id_usuario = uc.id_usuario 
WHERE u.id_usuario = 1;

# 2. Verificar API de roles
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     http://localhost:3000/api/users/1/roles

# 3. Verificar compilaci√≥n
npm run build -- --configuration=production
```

---

## üìû CONTACTO Y SOPORTE

**Desarrollador**: Chervas  
**Repositorios**: 
- Frontend: https://github.com/Chervas/cc-front
- Backend: https://github.com/Chervas/cc-back
- Demo: https://github.com/Chervas/cc-demo

**Estado del Proyecto**: Fase 3 completada, sistema funcional con problemas menores de configuraci√≥n

---

*Documentaci√≥n generada el 15 de julio de 2025 - Versi√≥n 1.0*

