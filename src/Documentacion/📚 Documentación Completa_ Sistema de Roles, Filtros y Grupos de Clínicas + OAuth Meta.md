# üìö Documentaci√≥n Completa: Sistema de Roles, Filtros y Grupos de Cl√≠nicas + OAuth Meta
## ClinicaClick - Sistema Integral de Gesti√≥n
## üìÖ **√öltima Actualizaci√≥n:** Enero 2025 - Estado: OAuth Meta Funcionando + Sistema de Roles Completo

---

## üéØ **OBJETIVO DE ESTA DOCUMENTACI√ìN**

Esta documentaci√≥n explica de manera exhaustiva c√≥mo funciona el sistema completo de ClinicaClick, incluyendo:
- Sistema de roles, filtros y grupos de cl√≠nicas
- Sistema OAuth Meta completamente funcional
- Mapeo de activos Meta a cl√≠nicas
- Arquitectura de usuarios dual (Fuse vs Backend)
- Flujos completos de autenticaci√≥n y autorizaci√≥n

---

## üìã **√çNDICE**

1. [Sistema de Usuarios y Roles](#sistema-usuarios-roles)
2. [Sistema OAuth Meta - FUNCIONANDO](#sistema-oauth-meta)
3. [Detecci√≥n de Administradores](#deteccion-administradores)
4. [Sistema de Grupos de Cl√≠nicas](#sistema-grupos-clinicas)
5. [Selector de Cl√≠nicas (Men√∫ de Iniciales)](#selector-clinicas)
6. [Filtros por Cl√≠nica en Vistas](#filtros-vistas)
7. [Mapeo de Activos Meta](#mapeo-activos-meta)
8. [Implementaci√≥n en Pacientes](#implementacion-pacientes)
9. [Flujo Completo del Sistema](#flujo-completo)
10. [Endpoints y APIs](#endpoints-apis)
11. [Archivos y Ubicaciones](#archivos-ubicaciones)

---

## üîê **1. SISTEMA DE USUARIOS Y ROLES** {#sistema-usuarios-roles}

### **1.1 Arquitectura Dual de Usuarios**

El sistema maneja **DOS modelos de usuario diferentes**:

#### **A) Usuario de FUSE (UI/UX)**
- **üìç Ubicaci√≥n:** `src/app/layout/common/user/user.component.ts`
- **üéØ Prop√≥sito:** Solo para elementos visuales del template
- **üìä Campos:**
  - `user.id` (string) - ID interno de Fuse
  - `user.email` - Email para mostrar en UI
  - `user.name` - Nombre para mostrar en header
  - `user.avatar` - Avatar para mostrar
  - `user.status` - Estado visual

#### **B) Usuario Real (L√≥gica de Negocio)**
- **üìç Ubicaci√≥n:** `src/app/core/user/user.service.ts`
- **üéØ Prop√≥sito:** Autenticaci√≥n, OAuth2, permisos, cl√≠nicas
- **üìä Campos:**
  - `user.id_usuario` (number) - ID real de base de datos
  - `user.email_usuario` - Email real del usuario
  - `user.nombre` - Nombre real
  - `user.apellidos` - Apellidos
  - **Relaciones:** Cl√≠nicas, roles, permisos

### **1.2 Mapeo Autom√°tico**

**üìç Ubicaci√≥n:** `src/app/core/user/user.service.ts`

El `UserService` mapea autom√°ticamente entre ambos modelos:
```typescript
// Mapeo de campos para compatibilidad
user.name = usuario.nombre + ' ' + usuario.apellidos;
user.email = usuario.email_usuario;
user.id = usuario.id_usuario.toString(); // String para Fuse
```

### **1.3 Reglas Cr√≠ticas**

‚ö†Ô∏è **IMPORTANTE:**
- **Para UI:** Usar `user.name`, `user.email` del modelo Fuse
- **Para OAuth2/Backend:** Usar `user.id_usuario` del UserService
- **NUNCA** usar `user.id` (string) para l√≥gica de negocio
- **OAuth2** usa `getUserIdForOAuth()` que devuelve `user.id_usuario` real

---

## üîó **2. SISTEMA OAUTH META - FUNCIONANDO** {#sistema-oauth-meta}

### **2.1 Estado Actual: ‚úÖ COMPLETAMENTE FUNCIONAL**

**Fecha de Resoluci√≥n:** Enero 2025

#### **üéâ Caracter√≠sticas Funcionando:**

1. **‚úÖ Conexi√≥n OAuth2 Meta**
   - Autorizaci√≥n completa con Meta
   - Intercambio de tokens de larga duraci√≥n
   - Almacenamiento seguro en base de datos

2. **‚úÖ Obtenci√≥n de Activos**
   - 107 p√°ginas de Facebook
   - 50 cuentas de Instagram Business
   - 65 cuentas publicitarias
   - Paginaci√≥n completa de API Meta

3. **‚úÖ Mapeo de Activos**
   - Stepper de 3 pasos funcional
   - Selecci√≥n m√∫ltiple de activos
   - Asignaci√≥n a m√∫ltiples cl√≠nicas
   - Inserci√≥n exitosa en base de datos

4. **‚úÖ Validaci√≥n y Seguridad**
   - Verificaci√≥n de tokens JWT
   - Validaci√≥n de permisos por usuario
   - Manejo de errores completo

### **2.2 Arquitectura OAuth Meta**

#### **üîπ Modelos de Base de Datos:**

**MetaConnection:**
```javascript
// cc-back/models/MetaConnection.js
{
    id: INTEGER (PK),
    userId: INTEGER,        // ID del usuario en ClinicaClick
    metaUserId: STRING,     // ID del usuario en Meta
    accessToken: TEXT,      // Token de larga duraci√≥n (60 d√≠as)
    expiresAt: DATE,        // Fecha de expiraci√≥n
    userName: STRING,       // Nombre del usuario Meta
    userEmail: STRING       // Email del usuario Meta
}
```

**ClinicMetaAsset:**
```javascript
// cc-back/models/ClinicMetaAsset.js
{
    id: INTEGER (PK),
    clinicaId: INTEGER,           // ID de la cl√≠nica
    metaConnectionId: INTEGER,    // Referencia a MetaConnection
    assetType: ENUM([             // ‚úÖ ENUM CORRECTO
        'facebook_page',
        'instagram_business',     // ‚úÖ NO 'instagram_business_account'
        'ad_account'
    ]),
    metaAssetId: STRING,          // ID del activo en Meta
    metaAssetName: STRING,        // Nombre del activo
    pageAccessToken: TEXT,        // Token espec√≠fico de p√°gina
    isActive: BOOLEAN,            // Estado del mapeo
    additionalData: JSON          // Datos extra (followers, etc.)
}
```

#### **üîπ Flujo OAuth2:**

```
1. Usuario ‚Üí Settings ‚Üí "Conectar Meta"
2. Redirecci√≥n a Meta con state=userId
3. Usuario autoriza en Meta
4. Callback con c√≥digo de autorizaci√≥n
5. Backend intercambia c√≥digo por token
6. Almacenamiento en MetaConnection
7. Redirecci√≥n con √©xito/error
8. Frontend muestra estado actualizado
```

### **2.3 Componente de Mapeo**

**üìç Ubicaci√≥n:** `src/app/modules/admin/pages/settings/shared/asset-mapping.component.ts`

#### **üîπ Stepper de 3 Pasos:**

**Paso 1: Selecci√≥n de Activos**
- Expansi√≥n por tipo (Facebook, Instagram, Ad Accounts)
- Informaci√≥n rica (avatares, m√©tricas, verificaci√≥n)
- Selecci√≥n m√∫ltiple con checkboxes
- B√∫squeda y filtrado

**Paso 2: Asignaci√≥n a Cl√≠nicas**
- Lista de cl√≠nicas con permisos del usuario
- Selecci√≥n m√∫ltiple de cl√≠nicas destino
- Resumen de activos seleccionados
- Validaci√≥n de selecciones

**Paso 3: Confirmaci√≥n**
- Resumen visual completo
- C√°lculo de mapeos a crear
- Confirmaci√≥n final
- Env√≠o al backend

#### **üîπ Mapeo de Tipos (CR√çTICO):**

```typescript
/**
 * ‚úÖ M√âTODO CR√çTICO: Mapear tipo de activo para el backend
 * IMPORTANTE: El backend espera 'instagram_business', NO 'instagram_business_account'
 */
private mapAssetTypeForBackend(frontendType: string): string {
    switch (frontendType) {
        case 'facebook_page': return 'facebook_page';
        case 'instagram_business': return 'instagram_business'; // ‚úÖ CORREGIDO
        case 'ad_account': return 'ad_account';
        default: return frontendType;
    }
}
```

### **2.4 Endpoints OAuth Meta**

#### **üîπ Endpoints Funcionando:**

1. **GET `/oauth/meta/callback`** - Callback de autorizaci√≥n
2. **GET `/oauth/meta/connection-status`** - Estado de conexi√≥n
3. **GET `/oauth/meta/assets`** - Obtener activos Meta
4. **POST `/oauth/meta/map-assets`** - ‚úÖ **FUNCIONANDO** - Mapear activos
5. **DELETE `/oauth/meta/disconnect`** - Desconectar Meta

#### **üîπ Respuesta de Mapeo Exitoso:**

```json
{
    "message": "Activos de Meta mapeados correctamente.",
    "assets": [
        {
            "id": 43,
            "clinicaId": 1,
            "metaConnectionId": 67,
            "assetType": "facebook_page",
            "metaAssetId": "733324556521013",
            "metaAssetName": "Gemini S.L.",
            "pageAccessToken": null,
            "isActive": true,
            "updatedAt": "2025-01-11T15:52:42.192Z",
            "createdAt": "2025-01-11T15:52:42.192Z"
        }
    ]
}
```

---

## üîß **3. DETECCI√ìN DE ADMINISTRADORES** {#deteccion-administradores}

### **3.1 M√©todo Principal**

**üìç Ubicaci√≥n:** `src/app/layout/layouts/vertical/thin/thin.component.ts` (l√≠nea 101)

```typescript
private isAdmin(): boolean {
    if (!this.currentUser?.id_usuario) {
        return false;
    }
    return this.ADMIN_USER_IDS.includes(this.currentUser.id_usuario);
}
```

### **3.2 Array de Administradores**

```typescript
// Array que define qu√© usuarios son administradores
ADMIN_USER_IDS = [1, 2, 5]; // IDs de usuarios administradores
```

### **3.3 L√≥gica Diferenciada por Rol**

**üìç Ubicaci√≥n:** `thin.component.ts` (l√≠neas 124-152)

```typescript
if (this.isAdmin()) {
    console.log('üîß Usuario administrador detectado (ID:', user.id_usuario, ')');
    // Para el admin, obtener TODAS las cl√≠nicas del sistema
    this.contactsService.getClinicas().subscribe((allClinicas: any[]) => {
        // Procesar todas las cl√≠nicas
    });
} else {
    console.log('üë§ Usuario regular detectado (ID:', user.id_usuario, ')');
    // Para usuarios regulares, solo sus cl√≠nicas asignadas
    this.contactsService.getClinicasByUser(user.id_usuario).subscribe((userClinicas: any[]) => {
        // Procesar solo cl√≠nicas del usuario
    });
}
```

### **3.4 Diferencias por Rol**

#### **üëë Administradores (IDs: 1, 2, 5):**
- ‚úÖ **Acceso completo:** Todas las cl√≠nicas del sistema
- ‚úÖ **Sin restricciones:** Pueden ver/editar cualquier cl√≠nica
- ‚úÖ **Gesti√≥n OAuth:** Pueden mapear activos Meta a cualquier cl√≠nica
- ‚úÖ **Vista global:** Selector muestra todas las cl√≠nicas

#### **üë§ Usuarios Regulares:**
- ‚ö†Ô∏è **Acceso limitado:** Solo cl√≠nicas asignadas en `UsuarioClinica`
- ‚ö†Ô∏è **Restricciones:** No pueden acceder a cl√≠nicas no asignadas
- ‚ö†Ô∏è **OAuth limitado:** Solo pueden mapear a sus cl√≠nicas
- ‚ö†Ô∏è **Vista filtrada:** Selector muestra solo sus cl√≠nicas

---

## üè• **4. SISTEMA DE GRUPOS DE CL√çNICAS** {#sistema-grupos-clinicas}

### **4.1 Modelo GrupoClinica**

**üìç Ubicaci√≥n:** `cc-back/models/grupoclinica.js`

```javascript
// Modelo para agrupar cl√≠nicas relacionadas
GrupoClinica.init({
    id_grupo: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    nombre_grupo: DataTypes.STRING,
    descripcion_grupo: DataTypes.TEXT,
    fecha_creacion: DataTypes.DATE,
    configuracion_grupo: DataTypes.JSON,
    estado_grupo: DataTypes.ENUM(['activo', 'inactivo'])
});
```

### **4.2 Relaci√≥n Cl√≠nica-Grupo**

**üìç Ubicaci√≥n:** `cc-back/models/clinica.js`

```javascript
// Cada cl√≠nica puede pertenecer a un grupo
Clinica.init({
    // ... otros campos
    grupoClinicaId: {
        type: DataTypes.INTEGER,
        references: {
            model: 'GrupoClinicas',
            key: 'id_grupo'
        }
    }
});
```

### **4.3 Uso en el Frontend**

**üìç Ubicaci√≥n:** `src/app/layout/layouts/vertical/thin/thin.component.ts`

```typescript
// Agrupaci√≥n autom√°tica por grupo
private groupClinicasByGroup(clinicas: any[]): any {
    const grouped = {};
    
    clinicas.forEach(clinica => {
        const groupName = clinica.grupoNombre || 'Sin Grupo';
        if (!grouped[groupName]) {
            grouped[groupName] = [];
        }
        grouped[groupName].push(clinica);
    });
    
    return grouped;
}
```

---

## üéØ **5. SELECTOR DE CL√çNICAS (MEN√ö DE INICIALES)** {#selector-clinicas}

### **5.1 Componente Principal**

**üìç Ubicaci√≥n:** `src/app/layout/layouts/vertical/thin/thin.component.ts`

#### **üîπ Estructura del Selector:**

```html
<!-- Bot√≥n principal con inicial de cl√≠nica actual -->
<button class="clinic-selector-button">
    <div class="clinic-initial">{{ getCurrentClinicInitial() }}</div>
    <span class="clinic-name">{{ currentClinica?.nombre || 'Seleccionar' }}</span>
</button>

<!-- Men√∫ desplegable con todas las cl√≠nicas -->
<div class="clinic-dropdown">
    <div *ngFor="let group of groupedClinicas | keyvalue" class="clinic-group">
        <div class="group-header">{{ group.key }}</div>
        <div *ngFor="let clinica of group.value" class="clinic-item">
            <div class="clinic-initial">{{ getClinicInitial(clinica.nombre) }}</div>
            <span class="clinic-name">{{ clinica.nombre }}</span>
        </div>
    </div>
</div>
```

#### **üîπ L√≥gica de Iniciales:**

```typescript
// Generar inicial de cl√≠nica
getClinicInitial(nombre: string): string {
    if (!nombre) return '?';
    
    // Tomar primera letra de cada palabra significativa
    const words = nombre.split(' ').filter(word => 
        word.length > 2 && !['de', 'del', 'la', 'el', 'y'].includes(word.toLowerCase())
    );
    
    if (words.length >= 2) {
        return (words[0][0] + words[1][0]).toUpperCase();
    } else {
        return nombre.substring(0, 2).toUpperCase();
    }
}
```

### **5.2 Estados del Selector**

#### **üîπ Estado Inicial (Sin Cl√≠nica):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ?   Seleccionar    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **üîπ Estado con Cl√≠nica Seleccionada:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CD  Cl√≠nica Dental ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **üîπ Men√∫ Desplegable:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Grupo Madrid                    ‚îÇ
‚îÇ  CD  Cl√≠nica Dental Centro      ‚îÇ
‚îÇ  DN  Dental Norte               ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ Grupo Barcelona                 ‚îÇ
‚îÇ  DB  Dental Barcelona           ‚îÇ
‚îÇ  CB  Centro Bucal               ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ Sin Grupo                       ‚îÇ
‚îÇ  CM  Cl√≠nica M√≥stoles          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **5.3 Persistencia de Selecci√≥n**

**üìç Ubicaci√≥n:** `thin.component.ts`

```typescript
// Guardar selecci√≥n en localStorage
selectClinica(clinica: any): void {
    this.currentClinica = clinica;
    localStorage.setItem('selectedClinica', JSON.stringify(clinica));
    
    // Emitir evento para actualizar filtros
    this.clinicaSelectionService.setSelectedClinica(clinica);
    
    // Actualizar rutas y filtros
    this.updateFiltersForSelectedClinica();
}

// Recuperar selecci√≥n al cargar
ngOnInit(): void {
    const saved = localStorage.getItem('selectedClinica');
    if (saved) {
        this.currentClinica = JSON.parse(saved);
    }
}
```

---

## üîç **6. FILTROS POR CL√çNICA EN VISTAS** {#filtros-vistas}

### **6.1 Servicio de Filtros**

**üìç Ubicaci√≥n:** `src/app/core/services/clinica-selection.service.ts`

```typescript
@Injectable({
    providedIn: 'root'
})
export class ClinicaSelectionService {
    private selectedClinicaSubject = new BehaviorSubject<any>(null);
    public selectedClinica$ = this.selectedClinicaSubject.asObservable();
    
    setSelectedClinica(clinica: any): void {
        this.selectedClinicaSubject.next(clinica);
    }
    
    getSelectedClinica(): any {
        return this.selectedClinicaSubject.value;
    }
}
```

### **6.2 Implementaci√≥n en Componentes**

**üìç Ejemplo:** `src/app/modules/admin/pages/pacientes/pacientes.component.ts`

```typescript
export class PacientesComponent implements OnInit {
    selectedClinica: any = null;
    filteredPacientes: any[] = [];
    
    ngOnInit(): void {
        // Suscribirse a cambios de cl√≠nica
        this.clinicaSelectionService.selectedClinica$.subscribe(clinica => {
            this.selectedClinica = clinica;
            this.applyClinicaFilter();
        });
        
        // Cargar datos iniciales
        this.loadPacientes();
    }
    
    private applyClinicaFilter(): void {
        if (!this.selectedClinica) {
            this.filteredPacientes = this.allPacientes;
            return;
        }
        
        this.filteredPacientes = this.allPacientes.filter(paciente => 
            paciente.clinicaId === this.selectedClinica.id
        );
    }
}
```

### **6.3 Filtros Autom√°ticos**

#### **üîπ Tipos de Filtros:**

1. **Filtro por ID de Cl√≠nica:**
   ```typescript
   // Para datos con campo clinicaId directo
   data.filter(item => item.clinicaId === selectedClinica.id)
   ```

2. **Filtro por Relaci√≥n:**
   ```typescript
   // Para datos con relaciones complejas
   data.filter(item => item.clinica?.id === selectedClinica.id)
   ```

3. **Filtro por Array:**
   ```typescript
   // Para usuarios con m√∫ltiples cl√≠nicas
   data.filter(item => item.clinicaIds?.includes(selectedClinica.id))
   ```

#### **üîπ Aplicaci√≥n Autom√°tica:**

```typescript
// Interceptor que aplica filtros autom√°ticamente
@Injectable()
export class ClinicaFilterInterceptor implements HttpInterceptor {
    intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
        const selectedClinica = this.clinicaSelectionService.getSelectedClinica();
        
        if (selectedClinica && this.shouldApplyFilter(req.url)) {
            const filteredReq = req.clone({
                setParams: { clinicaId: selectedClinica.id.toString() }
            });
            return next.handle(filteredReq);
        }
        
        return next.handle(req);
    }
}
```

---

## üéØ **7. MAPEO DE ACTIVOS META** {#mapeo-activos-meta}

### **7.1 Integraci√≥n con Sistema de Cl√≠nicas**

El mapeo de activos Meta se integra perfectamente con el sistema de cl√≠nicas:

#### **üîπ Para Administradores:**
```typescript
// En asset-mapping.component.ts
async loadAvailableClinics(): Promise<void> {
    if (this.isAdmin()) {
        // Administradores ven TODAS las cl√≠nicas
        this.availableClinics = await this.clinicaService.getAllClinics();
    } else {
        // Usuarios regulares solo ven sus cl√≠nicas
        this.availableClinics = await this.clinicaService.getUserClinics(this.currentUser.id_usuario);
    }
}
```

#### **üîπ Validaci√≥n de Permisos:**
```typescript
// Verificar que el usuario puede mapear a la cl√≠nica seleccionada
private validateClinicaPermissions(clinicaId: number): boolean {
    if (this.isAdmin()) {
        return true; // Administradores pueden mapear a cualquier cl√≠nica
    }
    
    // Usuarios regulares solo a sus cl√≠nicas asignadas
    return this.availableClinics.some(clinica => clinica.id === clinicaId);
}
```

### **7.2 Flujo de Mapeo Completo**

```
1. Usuario conecta Meta ‚Üí OAuth2 ‚Üí MetaConnection creada
2. Usuario accede a "Mapear Activos" ‚Üí Carga activos de Meta
3. Paso 1: Selecciona activos (Facebook, Instagram, Ad Accounts)
4. Paso 2: Selecciona cl√≠nicas (filtradas por permisos)
5. Paso 3: Confirma mapeo ‚Üí Env√≠o al backend
6. Backend: Validaci√≥n + Inserci√≥n en ClinicMetaAsset
7. Frontend: Confirmaci√≥n de √©xito
```

### **7.3 Uso en Campa√±as**

```typescript
// Futuro: Selector de activos en creaci√≥n de campa√±as
export class CampaignCreationComponent {
    async loadAvailableAssets(): Promise<void> {
        const selectedClinica = this.clinicaSelectionService.getSelectedClinica();
        
        if (selectedClinica) {
            // Cargar solo activos mapeados a la cl√≠nica actual
            this.availableAssets = await this.oauthService.getAssetsByClinica(selectedClinica.id);
        }
    }
}
```

---

## üë• **8. IMPLEMENTACI√ìN EN PACIENTES** {#implementacion-pacientes}

### **8.1 Componente Pacientes**

**üìç Ubicaci√≥n:** `src/app/modules/admin/pages/pacientes/pacientes.component.ts`

#### **üîπ Filtrado Autom√°tico:**

```typescript
export class PacientesComponent implements OnInit, OnDestroy {
    // Datos
    allPacientes: any[] = [];
    filteredPacientes: any[] = [];
    selectedClinica: any = null;
    
    // Suscripciones
    private destroy$ = new Subject<void>();
    
    ngOnInit(): void {
        // Suscribirse a cambios de cl√≠nica seleccionada
        this.clinicaSelectionService.selectedClinica$
            .pipe(takeUntil(this.destroy$))
            .subscribe(clinica => {
                this.selectedClinica = clinica;
                this.applyFilters();
            });
        
        // Cargar datos iniciales
        this.loadPacientes();
    }
    
    private applyFilters(): void {
        if (!this.selectedClinica) {
            // Sin cl√≠nica seleccionada: mostrar todos (solo para admin)
            this.filteredPacientes = this.allPacientes;
        } else {
            // Con cl√≠nica seleccionada: filtrar por cl√≠nica
            this.filteredPacientes = this.allPacientes.filter(paciente => 
                paciente.clinicaId === this.selectedClinica.id
            );
        }
        
        console.log(`üìä Pacientes filtrados: ${this.filteredPacientes.length} de ${this.allPacientes.length}`);
    }
}
```

#### **üîπ Indicadores Visuales:**

```html
<!-- Header con informaci√≥n de filtro -->
<div class="filter-info" *ngIf="selectedClinica">
    <mat-chip color="primary">
        <mat-icon>business</mat-icon>
        {{ selectedClinica.nombre }}
    </mat-chip>
    <span class="patient-count">{{ filteredPacientes.length }} pacientes</span>
</div>

<!-- Lista de pacientes filtrada -->
<mat-table [dataSource]="filteredPacientes">
    <!-- Columnas de la tabla -->
</mat-table>
```

### **8.2 Creaci√≥n de Pacientes**

```typescript
// Al crear un paciente, asignar autom√°ticamente a cl√≠nica seleccionada
createPaciente(pacienteData: any): void {
    const selectedClinica = this.clinicaSelectionService.getSelectedClinica();
    
    if (selectedClinica) {
        pacienteData.clinicaId = selectedClinica.id;
    }
    
    this.pacientesService.createPaciente(pacienteData).subscribe(response => {
        this.loadPacientes(); // Recargar lista
    });
}
```

---

## üîÑ **9. FLUJO COMPLETO DEL SISTEMA** {#flujo-completo}

### **9.1 Flujo de Autenticaci√≥n**

```
1. Usuario hace login ‚Üí AuthService valida credenciales
2. Backend devuelve JWT + datos de usuario
3. UserService mapea usuario real ‚Üî usuario Fuse
4. Layout detecta si es admin o usuario regular
5. Carga cl√≠nicas seg√∫n permisos (todas vs asignadas)
6. Genera selector de cl√≠nicas con iniciales
7. Usuario selecciona cl√≠nica ‚Üí Filtros se aplican autom√°ticamente
```

### **9.2 Flujo de OAuth Meta**

```
1. Usuario va a Settings ‚Üí Connected Accounts
2. Click "Conectar Meta" ‚Üí OAuth2 flow
3. Meta autoriza ‚Üí Callback con c√≥digo
4. Backend intercambia c√≥digo por token ‚Üí MetaConnection
5. Frontend muestra "Meta Conectado"
6. Click "Mapear Activos" ‚Üí Asset Mapping Component
7. Stepper: Seleccionar activos ‚Üí Asignar cl√≠nicas ‚Üí Confirmar
8. Backend crea registros en ClinicMetaAsset
9. Activos disponibles para uso en campa√±as
```

### **9.3 Flujo de Filtros**

```
1. Usuario selecciona cl√≠nica en selector
2. ClinicaSelectionService emite evento
3. Todos los componentes suscritos reciben la cl√≠nica
4. Cada componente aplica su filtro espec√≠fico
5. Datos se actualizan autom√°ticamente
6. Selecci√≥n se persiste en localStorage
```

---

## üîó **10. ENDPOINTS Y APIS** {#endpoints-apis}

### **10.1 Endpoints de Cl√≠nicas**

#### **üîπ Backend (cc-back):**

```javascript
// Obtener todas las cl√≠nicas (solo admin)
GET /api/clinicas
// Respuesta: Array de todas las cl√≠nicas del sistema

// Obtener cl√≠nicas de un usuario espec√≠fico
GET /api/clinicas/user/:userId
// Respuesta: Array de cl√≠nicas asignadas al usuario

// Obtener cl√≠nica espec√≠fica
GET /api/clinicas/:id
// Respuesta: Datos completos de la cl√≠nica
```

#### **üîπ Frontend Services:**

```typescript
// src/app/core/services/clinica.service.ts
@Injectable()
export class ClinicaService {
    getAllClinics(): Observable<any[]> {
        return this.http.get<any[]>('/api/clinicas');
    }
    
    getUserClinics(userId: number): Observable<any[]> {
        return this.http.get<any[]>(`/api/clinicas/user/${userId}`);
    }
    
    getClinicById(id: number): Observable<any> {
        return this.http.get<any>(`/api/clinicas/${id}`);
    }
}
```

### **10.2 Endpoints OAuth Meta**

#### **üîπ Endpoints Funcionando:**

```javascript
// Conexi√≥n y estado
GET  /oauth/meta/connection-status  // Estado de conexi√≥n del usuario
GET  /oauth/meta/callback          // Callback de autorizaci√≥n Meta
DELETE /oauth/meta/disconnect      // Desconectar Meta

// Gesti√≥n de activos
GET  /oauth/meta/assets           // ‚úÖ Obtener activos Meta (paginaci√≥n completa)
POST /oauth/meta/map-assets       // ‚úÖ Mapear activos a cl√≠nicas (FUNCIONANDO)

// Gesti√≥n de mapeos (pendientes)
GET  /oauth/meta/mappings         // üîÑ Obtener mapeos existentes
DELETE /oauth/meta/unmap-asset    // üîÑ Desmapear activo espec√≠fico
```

#### **üîπ Estructura de Respuestas:**

**Obtener Activos:**
```json
{
    "success": true,
    "user_info": { "id": "123", "name": "Usuario" },
    "assets": {
        "facebook_pages": [...],
        "instagram_business_accounts": [...],
        "ad_accounts": [...]
    },
    "total_assets": 222
}
```

**Mapear Activos:**
```json
{
    "message": "Activos de Meta mapeados correctamente.",
    "assets": [
        {
            "id": 43,
            "clinicaId": 1,
            "metaConnectionId": 67,
            "assetType": "facebook_page",
            "metaAssetId": "733324556521013",
            "metaAssetName": "Gemini S.L.",
            "isActive": true
        }
    ]
}
```

---

## üìÅ **11. ARCHIVOS Y UBICACIONES** {#archivos-ubicaciones}

### **11.1 Backend (cc-back)**

```
models/
‚îú‚îÄ‚îÄ usuario.js                    ‚Üê Modelo de usuarios
‚îú‚îÄ‚îÄ clinica.js                   ‚Üê Modelo de cl√≠nicas
‚îú‚îÄ‚îÄ grupoclinica.js              ‚Üê Modelo de grupos
‚îú‚îÄ‚îÄ usuarioclinica.js            ‚Üê Relaci√≥n usuario-cl√≠nica
‚îú‚îÄ‚îÄ MetaConnection.js            ‚Üê ‚úÖ Conexiones OAuth Meta
‚îî‚îÄ‚îÄ ClinicMetaAsset.js           ‚Üê ‚úÖ Mapeos activos-cl√≠nicas

src/routes/
‚îú‚îÄ‚îÄ clinicas.routes.js           ‚Üê Endpoints de cl√≠nicas
‚îú‚îÄ‚îÄ usuarios.routes.js           ‚Üê Endpoints de usuarios
‚îî‚îÄ‚îÄ oauth.routes.js              ‚Üê ‚úÖ Endpoints OAuth Meta (FUNCIONANDO)

src/controllers/
‚îú‚îÄ‚îÄ auth.controllers.js          ‚Üê Autenticaci√≥n y JWT
‚îî‚îÄ‚îÄ clinicas.controllers.js      ‚Üê L√≥gica de cl√≠nicas
```

### **11.2 Frontend (cc-front)**

```
src/app/core/
‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îú‚îÄ‚îÄ user.service.ts          ‚Üê ‚úÖ Servicio de usuarios (mapeo dual)
‚îÇ   ‚îî‚îÄ‚îÄ user.types.ts            ‚Üê Tipos de usuario
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ clinica-selection.service.ts  ‚Üê Servicio de selecci√≥n de cl√≠nicas
‚îÇ   ‚îú‚îÄ‚îÄ clinica.service.ts       ‚Üê Servicio de cl√≠nicas
‚îÇ   ‚îî‚îÄ‚îÄ oauth.service.ts         ‚Üê ‚úÖ Servicio OAuth Meta
‚îî‚îÄ‚îÄ auth/
    ‚îî‚îÄ‚îÄ auth.service.ts          ‚Üê Autenticaci√≥n

src/app/layout/layouts/vertical/thin/
‚îú‚îÄ‚îÄ thin.component.ts            ‚Üê ‚úÖ Layout principal con selector de cl√≠nicas
‚îú‚îÄ‚îÄ thin.component.html          ‚Üê Template del layout
‚îî‚îÄ‚îÄ thin.component.scss          ‚Üê Estilos del selector

src/app/modules/admin/pages/
‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îú‚îÄ‚îÄ connected-accounts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connected-accounts.component.ts    ‚Üê ‚úÖ Gesti√≥n OAuth Meta
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ connected-accounts.component.html  ‚Üê Template OAuth
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ asset-mapping.component.ts         ‚Üê ‚úÖ Componente de mapeo (FUNCIONANDO)
‚îÇ       ‚îî‚îÄ‚îÄ asset-mapping.component.html       ‚Üê ‚úÖ Stepper de 3 pasos
‚îú‚îÄ‚îÄ pacientes/
‚îÇ   ‚îú‚îÄ‚îÄ pacientes.component.ts   ‚Üê Ejemplo de filtros por cl√≠nica
‚îÇ   ‚îî‚îÄ‚îÄ pacientes.component.html ‚Üê Template con filtros
‚îî‚îÄ‚îÄ [otros m√≥dulos]/
    ‚îî‚îÄ‚îÄ *.component.ts           ‚Üê Implementan filtros similares
```

### **11.3 Archivos de Configuraci√≥n**

```
cc-back/
‚îú‚îÄ‚îÄ .env                         ‚Üê Variables de entorno (JWT_SECRET pendiente)
‚îú‚îÄ‚îÄ config/database.js           ‚Üê Configuraci√≥n de base de datos
‚îî‚îÄ‚îÄ package.json                 ‚Üê Dependencias backend

cc-front/
‚îú‚îÄ‚îÄ src/environments/
‚îÇ   ‚îú‚îÄ‚îÄ environment.ts           ‚Üê Configuraci√≥n desarrollo
‚îÇ   ‚îî‚îÄ‚îÄ environment.prod.ts      ‚Üê Configuraci√≥n producci√≥n
‚îú‚îÄ‚îÄ angular.json                 ‚Üê Configuraci√≥n Angular
‚îî‚îÄ‚îÄ package.json                 ‚Üê Dependencias frontend
```

---

## üöÄ **PR√ìXIMOS DESARROLLOS**

### **Fase Actual: OAuth Meta Funcionando ‚úÖ**
- ‚úÖ Conexi√≥n OAuth2 completa
- ‚úÖ Mapeo de activos funcionando
- ‚úÖ Integraci√≥n con sistema de cl√≠nicas
- ‚úÖ Validaci√≥n de permisos

### **Fase 2: Visualizaci√≥n y Gesti√≥n**
- üîÑ **Endpoint GET `/oauth/meta/mappings`** - Obtener mapeos existentes
- üîÑ **Mostrar mapeos en interfaz** - Lista de activos mapeados por cl√≠nica
- üîÑ **Recarga autom√°tica** - Actualizar vista despu√©s de mapeo exitoso
- üîÑ **Gesti√≥n de mapeos** - Editar/eliminar mapeos existentes

### **Fase 3: Integraci√≥n Avanzada**
- üîÑ **Vista de cl√≠nica individual** - Mostrar activos Meta en dashboard de cl√≠nica
- üîÑ **Selector en campa√±as** - Usar activos mapeados en creaci√≥n de campa√±as
- üîÑ **Sincronizaci√≥n autom√°tica** - Actualizar m√©tricas de activos Meta

### **Fase 4: Optimizaci√≥n y Seguridad**
- üîÑ **Cache de activos Meta** - Evitar llamadas repetidas a API
- üîÑ **Renovaci√≥n autom√°tica de tokens** - Gesti√≥n proactiva de expiraci√≥n
- üîÑ **Migraci√≥n JWT a variables de entorno** - Mejorar seguridad
- üîÑ **Roles granulares** - Permisos espec√≠ficos por tipo de activo

---

## ‚ö†Ô∏è **CONSIDERACIONES IMPORTANTES**

### **Seguridad**
- ‚úÖ Tokens Meta de larga duraci√≥n (60 d√≠as)
- ‚úÖ Validaci√≥n de permisos por usuario y cl√≠nica
- ‚ö†Ô∏è JWT hardcodeado (migraci√≥n pendiente)
- ‚úÖ Soft delete para auditor√≠a

### **Rendimiento**
- ‚úÖ Paginaci√≥n completa de API Meta (hasta 50 p√°ginas)
- ‚úÖ Filtros autom√°ticos en frontend
- üîÑ Cache de activos (pendiente)
- üîÑ Lazy loading de componentes (pendiente)

### **Escalabilidad**
- ‚úÖ Arquitectura modular y extensible
- ‚úÖ Servicios reutilizables
- ‚úÖ Componentes standalone
- ‚úÖ Separaci√≥n clara de responsabilidades

---

**Documentaci√≥n actualizada:** 11 de Enero, 2025  
**Versi√≥n:** 4.0 - Sistema Completo Integrado  
**Estado:** ‚úÖ OAuth Meta funcionando + Sistema de roles y cl√≠nicas completo

**Pr√≥ximo objetivo:** Implementar visualizaci√≥n de mapeos existentes y gesti√≥n completa de activos Meta por cl√≠nica.

